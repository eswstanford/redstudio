<!doctype html>
<html>
<head data-ng-app data-ng-csp="">
  <meta charset="utf-8">
  <title>RED Studio</title>
  <meta name="description" content="Renewable Energy Design Studio" />
  <meta name="keywords" content="energy, sustainable, development, hydro, leaflet, esw, bootstrap, open source" />
  <meta name="author" content="ESW-Stanford - esw.stanford.edu" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="../css/bootstrap.css" />
  <link rel="stylesheet" href="../css/jasny-bootstrap.css" />
  <link rel="stylesheet" href="../css/redstudiostyle.css" />
  <link rel="stylesheet" href="../css/leaflet.css" />
  <link rel="stylesheet" href="../css/l.geosearch.css" />
  <link rel="stylesheet" href="../css/leaflet.draw.css" />
  <link rel="stylesheet" href="../css/wizard.css" />


  <script src="../js/angular.js"></script>
  <script src="../js/controllers.js"></script>
  <script src="../js/bootstrap.js"></script>
  <script src="../js/jasny-bootstrap.js"></script>
  <script type="text/javascript" src="../js/jquery.js"></script>
  <script type="text/javascript" src="../js/jquery.csv-0.71.min.js"></script>

  <script src="../js/leaflet.js"></script>
  <script src="../js/l.control.geosearch.js"></script>
  <script src="../js/l.geosearch.provider.google.js"></script>
  <script src="../js/leaflet.draw.js"></script>
  
  <script src="../js/edit/handler/Edit.Poly.js"></script>
  <script src="../js/edit/handler/Edit.SimpleShape.js"></script>
  <script src="../js/edit/handler/Edit.Circle.js"></script>
  <script src="../js/edit/handler/Edit.Rectangle.js"></script>

  <script src="../js/draw/handler/Draw.Feature.js"></script>
  <script src="../js/draw/handler/Draw.Polyline.js"></script>
  <script src="../js/draw/handler/Draw.Polygon.js"></script>
  <script src="../js/draw/handler/Draw.SimpleShape.js"></script>
  <script src="../js/draw/handler/Draw.Rectangle.js"></script>
  <script src="../js/draw/handler/Draw.Circle.js"></script>
  <script src="../js/draw/handler/Draw.Marker.js"></script>

  <script src="../js/ext/LatLngUtil.js"></script>
  <script src="../js/ext/LineUtil.Intersect.js"></script>
  <script src="../js/ext/Polygon.Intersect.js"></script>
  <script src="../js/ext/Polyline.Intersect.js"></script>

  <script src="../js/Control.Draw.js"></script>
  <script src="../js/Tooltip.js"></script>
  <script src="../js/Toolbar.js"></script>

  <script src="../js/draw/DrawToolbar.js"></script>
  <script src="../js/edit/EditToolbar.js"></script>
  <script src="../js/edit/handler/EditToolbar.Edit.js"></script>
  <script src="../js/edit/handler/EditToolbar.Delete.js"></script>

  <link href='http://fonts.googleapis.com/css?family=Actor' rel='stylesheet' type='text/css'>
  <style type="text/css">
	  body {
	    overflow: scroll;
	  }
      .leaflet-popup-content-wrapper, .leaflet-popup-tip {
        background: #f7f7f7;
      }
      .leaflet-control-geoloc {
        -webkit-border-radius: 5px 5px 5px 5px;
        border-radius: 5px 5px 5px 5px;
      }
	  .leaflet-draw-toolbar a {
	    background-image: url('../img/spritesheet.png');
	  }
	  #map-frame {
	    border: 1px solid #ddd;
		border-radius: 5px;
		height: 400px;
		margin-top: 40px;
	  }
	  #instr-frame {
	    text-align: center;
		margin-top: 30px;
	  }
      .row-fluid .span12 { 
	    margin-left: 0; 
      }
	  .form-set {
		text-align: center;
		height: 40px;
	  }

	  .btn-toolbar {
	    margin-left: auto;
		margin-right: auto;
        text-align: center;
	  }
	  #button-set-map {
	    visibility: hidden;
	  }
	  .pagination {
	    text-align: center;
	  }
	  .wizard {
	    margin-left: auto;
		margin-right: auto;
		display: table;
	  }
	  .content {
	    height: 130px;
      position: relative;
	  }

    #button-set-points
    {
      text-align: center;
    }
    </style>
  
</head>
<body>

<!-- start: navigation bar -->
  <div class = "row-fluid" align:"center">
    <ul class="topbar">
      <li class="logo"><a href><img src = "../img/logo.png"></img></a> </li>
      <li class="location" class="active"><a href="location.html"><span class="topbar-icon icon-map"></span><span class="topbar-label">Location</span></a></li>
      <li class="simulator"><a href><span class="topbar-icon icon-gauge"></span><span class="topbar-label">Simulator</span></a></li>
      <li class="finance"><a href="finance1.html"><span class="topbar-icon icon-chart-line"></span><span class="topbar-label">Finance</span></a></li>
      <li class="social"><a href="FamilyProfile.html"><span class="topbar-icon icon-users"></span><span class="topbar-label">Profile</span></a></li>
      <li class="technology"><a href="technology.html"><span class="topbar-icon icon-flash"></span><span class="topbar-label">Technology</span></a></li>
  </ul>
  </div>
<!-- end: navigation bar -->

  <div class="container-fluid">
  
	<!-- start: map frame -->
  
	<div class="row-fluid">
	  <div class="span8 offset2" id="map-frame">

		<script>

			function getURLParameter(name) {
				return decodeURI(
					(RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,])[1]
				);
			}

			var regionParameter = getURLParameter('region');
			var region = (regionParameter === 'undefined') ? '' : regionParameter;

			// Create map 
			var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png';
			var basemap = new L.TileLayer(cloudmadeUrl, {maxZoom: 18});
			
			var map = new L.Map('map-frame', {
			  layers: [basemap], 
			  center: new L.LatLng(-6, 106), zoom: 6
			});

			// Initialize the search control
			var geoSearch = new L.Control.GeoSearch({
				provider: new L.GeoSearch.Provider.Google(),
				zoomLevel: 16
			})
			geoSearch.addTo(map);
			var geoSearchShow = true;

			// Initialize the search control
			var scaleControl = new L.Control.Scale();
			map.addControl(scaleControl);
			
			// Initialize the FeatureGroup to store editable layers
			var drawnItems = new L.FeatureGroup();
			map.addLayer(drawnItems);

			// Initialize the draw control and pass it the FeatureGroup of editable layers
			var drawControl = new L.Control.Draw({
				draw: {
				  polygon: false,
				  circle: false,
				  marker: false
				},
				edit: {
				  featureGroup: drawnItems
				}
			});
			
			// Track draw control add and remove with boolean
			map.addControl(drawControl);
			var drawControlShow = true;

		  </script>

      </div>
    </div>
	
	<!-- end: map frame -->
	
	<!-- start: content frame -->
	
	<div class="row-fluid content">
	  <div class="span8 offset2" id="instr-frame">
	  </div>
	  
	  <div class="span12 panel" id="form-set-lat-lng">
	    <form class="form-inline form-set" >
		  <input type="text" class="input-medium" id="lat-field" placeholder="Latitude in degrees">
		  <input type="text" class="input-medium" id="lng-field" placeholder="Longitude in degrees">
		  <button type="submit" class="btn" id="lat-lng-submit">Submit</button>
        </form>
	  </div>
	  
	  <div class="span12 panel" id="button-set-site">
	    <div class="btn-toolbar">
		  <button class="btn" id="btn-set-site">Set Boundary</button>
		  </div>
	  </div>
	  
	  <div class="span12 panel" id="form-set-upload">
	    <form class="form-inline form-set">
  		  <span class="btn btn-file">Upload GPS Data<input type="file" id="gps-file-upload"/></span>
		  </form>
	  </div>
 
	  <div class="span12 panel" id="button-set-points">
    </div>
  </div>
  <!-- end: content frame -->
		
	<!-- start: page navigation -->
	
  <div class="row-fluid">
	  <div class="span12" id="page-nav">
	  	<div class="wizard">
		  <a href="javascript:void(0);" onclick="showScreenMap();" id="step1" class="step"><span class="badge">1</span> Site Location</a>
		  <a href="javascript:void(0);" onclick="showScreenSite();" id="step2" class="step"><span class="badge">2</span> Site Boundaries</a>
	    <a href="javascript:void(0);" onclick="showScreenData();" id="step3" class="step"><span class="badge">3</span> Data Upload </a>
		  <a href="javascript:void(0);" onclick="showScreenPoints();" id="step4" class="step"><span class="badge">4</span> Points of Interest </a> 
		  <a href="javascript:void(0);" onclick="showScreenPoints();" id="step5" class="step"><span class="badge">5</span> Community Survey </a> 
		  </div>
    </div>
	</div>
	
  <!-- end: page navigation -->

  <script type="text/javascript">
  
    /* =======================
     * Handle Navigation
     * =======================
     */

    function reset() {
  	  $('.button-set').hide();
  	  $('.panel').hide();
  	  if (geoSearchShow == true) {
  	    geoSearch.removeFrom(map);
  		  geoSearchShow = false;
  	  }
  	  if (drawControlShow == true) {
  	    map.removeControl(drawControl);
  		  drawControlShow = false;
  	  }
  	  
  	  $('.step').removeClass('current');
	  }
	
  	function setInstructions(msg) {
  	  $('#instr-frame').html(msg);
  	}
  	
  	function showScreenMap() {
  	  reset();
  	  $('#step1').addClass('current');
  	  $('#button-set-map').show();
  	  $('#form-set-lat-lng').show();
  	  if (geoSearchShow == false) {
  	    geoSearch.addTo(map);
  		  geoSearchShow = true;
  	  }
  	  setInstructions('Enter the project location in the search field above. OR Enter the latitude and longitude below.');
  	}
  		
  	function showScreenSite() {
  	  reset();
  	  $('#step2').addClass('current');
  	  $('#button-set-site').show();
  	  if (drawControlShow == false) {
  	    map.addControl(drawControl);
  	    drawControlShow = true;
  	  }
  	  setInstructions('Use rectangle tool to mark boundaries of project site.');
  	}
  	
  	function showScreenData() {
  	  reset();
  	  $('#step3').addClass('current');
  	  $('#button-set-data').show();
  	  $('#form-set-upload').show();
  	  setInstructions('Click button below to upload *.csv files with GPS data for POIs or contour data for elevations.');
  	}
  	
  	function showScreenPoints() {
  	  reset();
  	  $('#step4').addClass('current');
  	  $('#button-set-points').show();
  	  setInstructions('Click buttons below to mark points of interest');
  	}
  	
  	reset();
  	showScreenMap();
	
	</script>

	
	<script>
	
    /* =======================
     * Step 1: Site Location
     * =======================
     */
  	map.on('geosearch_showlocation', function(result) {
  	  setInstructions('Click on center of project location.');
  	});
  	
  	var marker;
  		
  	map.on('click', function(e) {
  	  if (marker) {
  	    map.removeLayer(marker);
  	  }
  	  map.removeLayer(geoSearch._positionMarker);
  	  var center = e.latlng;
  	  marker = new L.marker(center);
  	  marker.addTo(map);
  	  map.panTo(center);
  	  setInstructions('If the center of the project location is correct, please click next step.');
  	});
  	
  	function getInputLatLng() {
  	  var latInput = $('#lat-field').val();
  	  var lngInput = $('#lng-field').val();
  	  var lat = parseFloat(latInput);
  	  var lng = parseFloat(lngInput);
  	  if (isNaN(lat) || lat > 180 || lat < -180) {
  	    alert("'" + latInput + "'" + " is not a valid latitude.");
  		$('#lat-field').val("");
  	  }
  	  if (isNaN(lng) || lng > 180 || lng < -180) {
  	    alert("'" + lngInput + "'" + " is not a valid longitude.");
  		$('#lng-field').val("");
  	  }
  	  else {
  	    var latlng = new L.LatLng(lat, lng);
  	    return latlng;
  	  }
  	};
  	
  	function centerMap(center) {
  	  L.marker(center).addTo(map);
  	  map.panTo(center);
  	  map.setZoom(16);
  	  setInstructions('If the center of the project location is correct, please click next step.');
  	}
  	
  	$('#lat-lng-submit').click(function(e) {
  	  e.preventDefault();
  	  var center = getInputLatLng();
  	  centerMap(center);
  	});
  	
    /* =======================
     * Step 2: Site Boundaries
     * =======================
     */

  	var bounds;
  	
  	map.on('draw:created', function (e) {
  	  setInstructions('If the project boundary marked by the rectangle is correct, please click "Set Boundary" button.');
  	  var type = e.layerType,
  		layer = e.layer;
  	  if (type === 'rectangle') {
  		bounds = layer.getBounds();
  	  }
  	  drawnItems.addLayer(layer);
  	});
  	
  	$('#btn-set-site').click(function (e) {
  	  map.fitBounds(bounds);
  	  setInstructions('If the project boundary is correct, please click next step.');
  	});
  	

    /* =======================
     * Setup for Step 3 & Step 4
     * =======================
     */

    var iconMapping = {
      "System"      : "powersubstation.png",
      "Residential" : "townhouse.png",
      "Productive"  : "wifi.png",
      "Community"   : "communitycentre.png" 
    }

    var locationTypes = [
      "System",
      "Residential",
      "Productive",
      "Community"
    ]
    
    function drawCheckboxes()
    {
      var html = '';
      for(var i = 0; i < locationTypes.length; i++)
      {
        var type = locationTypes[i];
        html += '<label class="checkbox inline">' + 
                '<input class="location-checkbox" type="checkbox" id="' + type + '-checkbox" value="option1" checked> <img src="../img/' + iconMapping[type] + '" /> ' + type +  
                '</label>';
      }
      $('#button-set-points').html(html);
    }

    function isChecked(type)
    {
      return $("#" + type + "-checkbox").is(':checked');
    }

    drawCheckboxes();

    /* =======================
     * Step 3: Data Upload
     * =======================
     */


    var gpsData;
    var gpsMarkers = [];

    function getIcon(filename)
    {
      var icon = L.icon({
        iconUrl: "../img/" + filename,
        iconSize: [32, 37],
        iconAnchor: [16, 37],
        popupAnchor: [-0, -37]
      });
      return icon;
    }

  	function processRow(row)
    {
      var id = row[0];
      var type = row[1];
      var lat = row[2];
      var lng = row[3];
      var elevation = row[4];
      
      if(isChecked(type)) {
        var marker = L.marker(new L.LatLng(lat, lng),
          {
            icon: getIcon(iconMapping[type])
          }).addTo(map);

        var popupContent = "Elevation: " + elevation;
        marker.bindPopup(popupContent);
        gpsMarkers.push(marker);
      }
    }  

    function processGPSData(gpsData)
    {
      //Remove existing markers
      for(var i = 0; i < gpsMarkers.length; i++)
      {
        map.removeLayer(gpsMarkers[i]);
      }
      gpsMarkers = [];

      for(var i = 0; i < gpsData.length; i++)
      {
        processRow(gpsData[i]);
      }
    }

  	$('#gps-file-upload').change(function(e)
    {
      var file = e.currentTarget.files[0];
      if(file)
      {

        var r = new FileReader();
        r.onload = function(e) {
          gpsData = $.csv.toArrays(e.target.result);
          processGPSData(gpsData);
        }
        r.readAsText(file);
      }
    })

    
    /* ==========================
     * Step 4: Points of Interest
     * ==========================
     */

    $(".location-checkbox").click(function() {
      processGPSData(gpsData);
    });

  </script>

  
</body>
</html>